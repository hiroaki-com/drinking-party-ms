{% extends "base.html" %}

{% block title %}detail{% endblock %}

{% block content %}
<h3 class="mb-5">
  詳細／参加可否
</h3>
<div class="container">
  <div class="card" style="max-width: 40rem;">
    <div class="card-header">
      <div style='text-align: left;'><b>{{ object.title }}</b></div>
    </div>
    <ul class="list-group list-group-flush">
      <li class="list-group-item">開催日時： <u>{{ object.date }} {{ object.time }}</u> ~</li>
      <li class="list-group-item">店舗 : {{ object.restaurant }}</li>
      <li class="list-group-item">場所 : {{ object.address }}</li>
      <li class="list-group-item">店舗URL : <br>
        <a href="{{ object.url }}" target="_blank" rel="noopener noreferrer" style="font-size: 10px">
          {{ object.url }}<i class="fa-solid fa-up-right-from-square fa-xs"></i>
        </a><div class="font-awsome" style='font-family: Font Awesome 5 Free;'></div>
      </li>
      <li class="list-group-item">予約名 : {{ object.subscriber }}</li>
      <li class="list-group-item">予算 : {{ object.fee }}円</li>
      <li class="list-group-item">備考 : {{ object.comment }}</li>
      <li class="list-group-item">作成者 : {{ object.user }}</li>
    </ul>  
    <div class="card-footer">
      <div style="font-size: 10px;">作成日時 : {{ object.create_dt }}</div>
      <div style="font-size: 10px;">最終更新 : {{ object.mod_dt }}</div>
      <div class="d-flex mt-1 justify-content-end">
        <div class="update">
          <a href="{% url 'party:update_party' party.pk%}">編集</a>
        </div>
        <div class="delete ms-3 justify-content-end">
          <a href="{% url 'party:delete_party' party.pk%}">削除</a>
        </div>    
      </div>
    </div>
  </div>
</div>
<div class="container-fluid mt-2">
  <div class="row">
    <!-- 参加ボタン -->
    <div class="col-2">
      {% if is_user_joined_for_party %}
      <button type="button" id="ajax-join_for_party" style="border:none;background:none">
        <i class="fas fa-heart text-danger" id="join_for_party-icon"></i>
      </button>
      {% else %}
      <button type="button" id="ajax-join_for_party" style="border:none;background:none">
        <i class="far fa-heart text-primary" id="join_for_party-icon"></i>
      </button>
      {% endif %}
      <div>参加</div>
      <div class="mb-2">
        <span id="join_for_party-count">{{ join_for_party_count }}</span><span>名</span>
      </div>
      {% for join in join_for_party_member %}
        <div>{{ join.user }}</div>
      {% endfor %}
    </div>
    <!-- /参加ボタン -->
    <!-- 不参加ボタン -->
    <div class="col-2">
      {% if is_user_not_joined_for_party %}
      <button type="button" id="ajax-not_join_for_party" style="border:none;background:none">
        <i class="fas fa-face-sad-tear text-primary" id="not_join_for_party-icon"></i>
      </button>
      {% else %}
      <button type="button" id="ajax-not_join_for_party" style="border:none;background:none">
        <i class="far fa-face-sad-tear text-primary" id="not_join_for_party-icon"></i>
      </button>
      {% endif %}
      <div>不参加</div>
      <div class="mb-2">
        <span id="not_join_for_party-count">{{ not_join_for_party_count }}</span><span>名</span>
      </div>
      {% for not_join in not_join_for_party_member %}
        <div>{{ not_join.user }}</div>
      {% endfor %}
    </div>
    <!-- /不参加ボタン -->
    <!-- 未定ボタン -->
    <div class="col-2">
      {% if is_user_tbd_for_party %}
      <button type="button" id="ajax-tbd_for_party" style="border:none;background:none">
        <i class="fas fa-spinner text-dark" id="tbd_for_party-icon"></i>
      </button>
      {% else %}
      <button type="button" id="ajax-tbd_for_party" style="border:none;background:none">
        <i class="far fa-circle-user text-primary" id="tbd_for_party-icon"></i>
      </button>
      {% endif %}
      <div>未定</div>
      <div class="mb-2">
        <span id="tbd_for_party-count">{{ tbd_for_party_count }}</span><span>名</span>
      </div>
      {% for tbd in tbd_for_party_member %}
        <div>{{ tbd.user }}</div>
      {% endfor %}
    </div>
    <!-- /未定ボタン -->
    <div class="col-6">
      <!-- 4つめの空白箱（ボタン達を左に寄せる目的） -->
    </div>
  </div>
</div>
  {% block extrajs %}
  <script type="text/javascript">
    /* 飲み会への参加ボタン */
    document.getElementById('ajax-join_for_party').addEventListener('click', e => {
      e.preventDefault();
      const url = '{% url "party:join_for_party" %}';
      fetch(url, {
        method: 'POST',
        body: `party_pk={{ party.pk }}`,
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8',
          'X-CSRFToken': '{{ csrf_token }}',
        },
      }).then(response => {
        return response.json();
      }).then(response => {
        // 参加数を書き換える
        const counter = document.getElementById('join_for_party-count')
        counter.textContent = response.join_for_party_count
        const icon = document.getElementById('join_for_party-icon')
        // 作成した場合はハートを塗る
        if (response.method == 'create') {
          icon.classList.remove('far','text-primary')
          icon.classList.add('fas','text-danger')
          icon.id = 'join_for_party-icon'
        } else {
          icon.classList.remove('fas','text-danger')
          icon.classList.add('far','text-primary')
          icon.id = 'join_for_party-icon'
        }
      }).catch(error => {
        console.log(error);
      });
    });
    /* 不参加ボタン */
    document.getElementById('ajax-not_join_for_party').addEventListener('click', e => {
      e.preventDefault();
      const url = '{% url "party:not_join_for_party" %}';
      fetch(url, {
        method: 'POST',
        body: `party_pk={{ party.pk }}`,
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8',
          'X-CSRFToken': '{{ csrf_token }}',
        },
      }).then(response => {
        return response.json();
      }).then(response => {
        const counter = document.getElementById('not_join_for_party-count')
        counter.textContent = response.not_join_for_party_count
        const icon = document.getElementById('not_join_for_party-icon')
        if (response.method == 'create') {
          icon.classList.remove('far','text-primary')
          icon.classList.add('fas','text-primary')
          icon.id = 'not_join_for_party-icon'
        } else {
          icon.classList.remove('fas','text-primary')
          icon.classList.add('far','text-primary')
          icon.id = 'not_join_for_party-icon'
        }
      }).catch(error => {
        console.log(error);
      });
    });
    /* 未定ボタン */
    document.getElementById('ajax-tbd_for_party').addEventListener('click', e => {
      e.preventDefault();
      const url = '{% url "party:tbd_for_party" %}';
      fetch(url, {
        method: 'POST',
        body: `party_pk={{ party.pk }}`,
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8',
          'X-CSRFToken': '{{ csrf_token }}',
        },
      }).then(response => {
        return response.json();
      }).then(response => {
        const counter = document.getElementById('tbd_for_party-count')
        counter.textContent = response.tbd_for_party_count
        const icon = document.getElementById('tbd_for_party-icon')
         /* アイコン自体変更 */
        if (response.method == 'create') {
          icon.classList.remove('far','fa-circle-user','text-primary')
          icon.classList.add('fas','fa-spinner','text-dark')
          icon.id = 'tbd_for_party-icon'
        } else {
          icon.classList.remove('fas','fa-spinner','text-dark')
          icon.classList.add('far','fa-circle-user','text-primary')
          icon.id = 'tbd_for_party-icon'
        }
      }).catch(error => {
        console.log(error);
      });
    });
  </script>
  {% endblock %}

{% endblock %}
